<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v6.js"></script>

<!-- Create an element where the map will take place -->
<svg id="my_dataviz" width="935" height="778"></svg>

<script>
    // The svg
    const svg = d3.select("svg"),
        width = +svg.attr("width"),
        height = +svg.attr("height");

    // Map and projection
    const projection = d3.geoMercator()
        .scale(25000)  // Adjusted scale for Singapore
        .center([103.8198, 1.3521])  // Singapore's center
        .translate([width / 2, height / 2]);

    const path = d3.geoPath().projection(projection);

    // Data and color scale
    const data = new Map();

    const colorScale = d3.scaleThreshold()
        .domain([9000, 10000, 15000, 20000, 25000, 30000, 35000])  // Use appropriate values for your regions
        .range(d3.schemeBlues[7]);  // Choose a color scheme (Blues with 7 colors)

    // Error handling for data loading
    function handleError(error) {
        console.error("Data load error:", error);
        alert("There was an error loading the data. Check the console for details.");
    }

    // Load external data
    Promise.all([
        d3.json("singapore_region.geojson")  // Load the GeoJSON for Singapore
            .then((geoData) => { 
                console.log("GeoJSON loaded successfully:", geoData); 
                return geoData; 
            })
            .catch(handleError),
        d3.csv("new_region.csv", function (d) {
            // Set the count for each region
            data.set(d.district.trim(), +d.count);  // No lowercase conversion, just trimming spaces
        })
            .then(() => { 
                console.log("CSV data loaded successfully:", data); 
            })
            .catch(handleError)
    ]).then(function (loadData) {
        let topo = loadData[0];  // Assign GeoJSON data to 'topo'

        if (!topo || !topo.features) {
            console.error("GeoJSON file doesn't have valid features.");
            alert("GeoJSON features are invalid.");
            return;
        }
        // Draw the map
        svg.append("g")
            .selectAll("path")
            .data(topo.features)  // Bind the GeoJSON features (regions)
            .enter()
            .append("path")
            .attr("d", path)  // Define the shape of each region
            .attr("fill", function (d) {
                const regionName = d.properties.district.trim();  // Only trim, no lowercase conversion
                const value = data.get(regionName) || 0;  // Get the corresponding count value from CSV
                return value ? colorScale(value) : "#ccc";  // Use colorScale for the value, default color if not found
            })
            .style("stroke", "#333")  // Add borders for visibility
            .style("stroke-width", "1px")
            .attr("class", "region")
            .style("opacity", .8);  // Adjust opacity for better visibility
    }).catch(function (error) {
        console.error("Error loading data:", error); // Log errors
    });
</script>
