<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v6.js"></script>

<!-- Create an element where the map will take place -->
<svg id="my_dataviz" width="800" height="800"></svg>

<script>
    // The svg
    const svg = d3.select("svg"),
        width = +svg.attr("width"),
        height = +svg.attr("height");

    // Map and projection
    const projection = d3.geoMercator()
        .scale(10000)  // Adjust the scale for a better fit
        .center([103.8198, 1.3521])  // Singapore's center coordinates
        .translate([width / 2, height / 2]);

    const path = d3.geoPath().projection(projection);

    // Data and color scale
    const data = new Map();
    const colorScale = d3.scaleThreshold()
        .domain([10000, 15000, 20000, 25000, 30000])
        .range(d3.schemeBlues[7]);

    // Add error handling for data loading
    function handleError(error) {
        console.error("Data load error:", error);
        alert("There was an error loading the data. Check the console for details.");
    }

    // Load external data (GeoJSON and CSV)
    Promise.all([
        d3.json("singapore-region.geojson")
            .then((geoData) => { 
                console.log("GeoJSON loaded successfully:", geoData); 
                return geoData; 
            })
            .catch(handleError),
        d3.csv("region.csv", function (d) {
            // Set the count for each region
            data.set(d.region.trim(), +d.count);
        })
            .then(() => { 
                console.log("CSV data loaded successfully:", data); 
            })
            .catch(handleError)
    ]).then(function (loadData) {
        let geojson = loadData[0];

        if (!geojson || !geojson.features) {
            console.error("GeoJSON file doesn't have valid features.");
            alert("GeoJSON features are invalid.");
            return;
        }

        // Check if the properties of the GeoJSON features match what you're trying to access
        console.log("GeoJSON feature properties sample:", geojson.features[0].properties);

        // Mouse interaction functions
        let mouseOver = function () {
            d3.selectAll(".region")
                .transition()
                .duration(200)
                .style("opacity", 0.5);
            d3.select(this)
                .transition()
                .duration(200)
                .style("opacity", 1);
        };

        let mouseLeave = function () {
            d3.selectAll(".region")
                .transition()
                .duration(200)
                .style("opacity", 0.8);
            d3.select(this)
                .transition()
                .duration(200);
        };

        // Draw the map
        svg.append("g")
            .selectAll("path")
            .data(geojson.features)
            .enter()
            .append("path")
            .attr("d", path)
            .attr("fill", function (d) {
                const regionName = d.properties.shape1;  // Adjust to match your GeoJSON properties
                const value = data.get(regionName) || 0;
                console.log("Region:", regionName, "Count:", value);
                return colorScale(value);
            })
            .style("stroke", "#333")  // Add borders for better visibility
            .style("stroke-width", "1px")
            .attr("class", "region")
            .style("opacity", 0.8)
            .on("mouseover", mouseOver)
            .on("mouseleave", mouseLeave);
    }).catch(function (error) {
        console.error("Error loading data:", error); // Log errors
    });
</script>
